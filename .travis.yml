# We deliberately don't use travis's language=python option because
# we install miniconda and use conda to get python. Additionally,
# Travis's auto-install of python doesn't work on osx images (see
# https://github.com/travis-ci/travis-ci/issues/4729).

# This file should be using semantically named doit commands defined in
# dodo.py
language: generic
sudo: false
os:
  - linux

env:
  global:
    - PYENV_VERSION=3.7
    - RUN_LINT=true  # use this var to turn off linting for a specific dir
    - RUN_TEST=true  # use this var to turn off testing for a specific dir

stages:
  - name: test
    if: commit_message !~ /^.*(build:).*$/
  - name: docs
    if: commit_message =~ /^.*(build:).*$/
  - name: deploy
    if: commit_message =~ /^.*(build:).*$/

jobs:
  include:
    # Use [only:<example_dir>] in your commit message to only run a particular set of tests
    - &test_project
      stage: test
      env: DIR=attractors
      if: |
        (commit_message !~ /^.*(only:).*$/) OR
        (commit_message =~ concat(^.*,env(DIR),.*$))
      before_install:
        - pip install pyctdev && doit miniconda_install
        - export PATH="$HOME/miniconda/bin:$PATH" && hash -r
        - doit ecosystem_setup
      script:
        - doit small_data_setup --name $DIR
        - cd $DIR
        - if ! anaconda-project list-downloads | grep -q 'No downloads'; then
            if ! [ -d data ]; then
              echo 'FAIL needs data and no test data found' && exit 1;
            fi;
          fi
        - $RUN_LINT && anaconda-project run lint || echo "skipping lint"
        - $RUN_TEST && anaconda-project run test || echo "skipping test"
        - cd ..
        - doit small_data_cleanup --name $DIR

    - <<: *test_project
      env: DIR=bay_trimesh

    - <<: *test_project
      env: DIR=census

    - <<: *test_project
      env: DIR=gerrymandering

    - <<: *test_project
      env: DIR=landsat

    - <<: *test_project
      env: DIR=network_packets

    - <<: *test_project
      env: DIR=nyc_taxi

    - <<: *test_project
      env: DIR=opensky

    - <<: *test_project
      env: DIR=osm

    - <<: *test_project
      env: DIR=uk_researchers

    - &build_project
      <<: *test_project
      stage: docs
      env: DIR=attractors
      if: |
        (commit_message =~ concat(^.*,env(DIR),.*$)) OR
        (commit_message =~ /^.*(build:all).*$/)
      script:
        - cd $DIR
        - anaconda-project prepare
        - source activate envs/default
        - conda install -c pyviz/label/dev nbsite sphinx_pyviz_theme
        - nbsite generate-rst --org pyviz-topics --repo examples --project-name $DIR --doc ../doc --examples .  --skip "envs/.*"
        - nbsite build --doc=../doc --what=html --output=../builtdocs
        - cd ..
      after_success:
        - git config user.email "travis@travis.org"
        - git config user.name "travis"
        - git add ./doc/$DIR.ipynb ./doc/*.json
        - git commit --allow-empty -m "updated $DIR"
        - git push "https://pyviz-developers:$GITHUB_TOKEN@github.com/pyviz-topics/examples.git" HEAD:evaluated &>/dev/null

    - <<: *build_project
      env: DIR=bay_trimesh

    - <<: *build_project
      env: DIR=census

    - <<: *build_project
      env: DIR=gerrymandering

    - <<: *build_project
      env: DIR=landsat

    - <<: *build_project
      env: DIR=network_packets

    - <<: *build_project
      env: DIR=nyc_taxi

    - <<: *build_project
      env: DIR=opensky

    - <<: *build_project
      env: DIR=osm

    - <<: *build_project
      env: DIR=uk_researchers

    - &build_website
      stage: docs
      before_install:
        - pip install pyctdev && doit miniconda_install
        - export PATH="$HOME/miniconda/bin:$PATH" && hash -r
        - doit ecosystem_setup
        - conda install -y -c pyviz/label/dev nbsite sphinx_pyviz_theme
      script:
        - unset DIR

      deploy:
        - provider: pages
          skip_cleanup: true
          github_token: $GITHUB_TOKEN
          keep-history: true
          local_dir: ./builtdocs
          on:
            all_branches: true


notifications:
  email: false
