# Build the main or dev websites

#########
# IMPORTANT: it is also responsible for merging the `tmp_evaluated_{PRBranchName}` branch
# into `evaluated` and PUSHING the merge to `evaluated`.
# This happens whenever a PR is merged.
########

# Runs on:
# direct push to main: checkout `evaluated` and build main site
# merged PRs: merge `tmp_evaluated_{PRBranchName}` into`evaluated 
# ,push to `evaluated` and build main site
# workflow_call (from pr_flow.yml):
#   - at least one project built: pull the `tmp_evaluated_{PRBranchName}`
#     and `evaluated` branches, merge locally (NOT pushed), and build the dev site
#   - no project built, checkout `evaluated` and build main site
# workflow_dispatch: checkout `evaluated` and build main or dev site
# schedule: checkout `evaluated` and build dev site

name: docs

on:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - "main"
    types:
      - closed
  workflow_call:
    inputs:
      target:
        description: Site to build and deploy, dev or main
        type: string
        required: true
        default: dev
      evaluated_branch:
        description: Branch to pull the evaluated projects from
        type: string
        required: true
        default: ''
      type:
        description: hack
        required: true
        type: string
      projects:
        description: Projects that were built
        type: string
        required: false
  workflow_dispatch:
    inputs:
      target:
        description: Site to build and deploy
        type: choice
        options:
        - dev
        - main
        - dryrun
        required: true
        default: dryrun
  schedule:
    - cron: '0 2 * * SUN'

jobs:
  build_docs:
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true 
    name: Documentation
    runs-on: 'ubuntu-latest'
    timeout-minutes: 30
    defaults:
      run:
        shell: bash -el {0}
    steps:
    - uses: actions/checkout@v3
    - name: debug
      run: |
        echo ${{ github.ref_name }}
        echo ${{ github.event_name }}
    - uses: hmarr/debug-action@v2
    - uses: conda-incubator/setup-miniconda@v2
      with:
        miniconda-version: "latest"
        auto-activate-base: false
        activate-environment: examples-gallery-doc
        environment-file: envs/environment-doc.yml
    - name: infer evaluated branch name and deplyment target
      id: set-vars
      run: |
        EVENTNAME="${{ github.event_name }}"
        # Called by pr_flow.yml, uses the tmp evaluated branch
        if [ "${{ inputs.type }}" == "workflow_call" ]; then
          NAME="${{ inputs.evaluated_branch }}"
          TARGET="dev"
        # Push the main, use the evaluated branch
        elif [ "$EVENTNAME" == "push" ]; then
          NAME="evaluated"
          TARGET="main"
        # Merged PRs, use the evaluated branch
        elif [ "$EVENTNAME" == "pull_request" ]; then
          NAME="tmp_evaluated_${{ github.event.pull_request.head.ref }}"
          TARGET="main"
        elif [ "$EVENTNAME" == "workflow_dispatch" ]; then
          NAME="evaluated"
          TARGET="${{ inputs.target }}"
        elif [ "$EVENTNAME" == "schedule" ]; then
          NAME="evaluated"
          TARGET="dev"
        fi
        echo "Evaluated branch: $NAME"
        echo "Target: $TARGET"
        echo "NAME=$NAME" >> $GITHUB_OUTPUT
        echo "TARGET=$TARGET" >> $GITHUB_OUTPUT
    - name: sync evaluated on merged PRs
      # The `evaluated` branch is only updated when a PR is merged.
      if: github.event_name == 'pull_request' && github.event.pull_request.merged == true 
      run: |
        PROJECTS=$(doit list_changed_dirs_with_last_commit | tail -n -1)
        if [ "$PROJECTS" != "[]" ] then;
          # Some changes were made, the evaluated branch needs to
          # be updated.
          DEVBRANCH=${{ steps.set-vars.outputs.name }}
          echo "Projects changed since last commit on main: $PROJECTS"
          echo "Merging the $DEVBRANCH branch into the evaluated branch "
          git config user.email "travis@travis.org"
          git config user.name "travis"
          git fetch https://github.com/${GITHUB_REPOSITORY}.git evaluated:refs/remotes/evaluated
          git fetch https://github.com/${GITHUB_REPOSITORY}.git $DEVBRANCH:refs/remotes/$DEVBRANCH
          git checkout evaluated
          git checkout $DEVBRANCH -- doc/
          git diff
          git commit -m "Add $PROJECTS"
          git log -n 10 --oneline
          echo "Push changes to evaluated"
          # TODO: remove dryrun
          git push --dry-run -f -q "https://pyviz-developers:${{ secrets.GITHUB_TOKEN }}@github.com/pyviz-topics/examples.git" HEAD:evaluated
          git checkout main
          git clean -fxd
        fi
    - name: checkout evaluated
      # any event that isn't workflow_call (coming from pr_flow.yml)
      # workflow_call events that didn't update any project at all
      if: inputs.type != 'workflow_call' || (inputs.type == 'workflow_call' && inputs.projects == '[]')
      run: |
        git checkout -b deploy--temp-asdfghjkl
        git fetch https://github.com/${GITHUB_REPOSITORY}.git evaluated:refs/remotes/evaluated
        git checkout evaluated -- ./doc
        tree doc -L 2
    - name: sync dev evaluated
      # workflow_call events (coming from pr_flow.yml) that did update at least one project
      if: inputs.type == 'workflow_call' && inputs.projects != '[]'
      run: |
        # We setup the repo so that it has the doc from the dev evaluated branch
        # and from the 
        git config user.email "travis@travis.org"
        git config user.name "travis"
        DEVBRANCH=${{ steps.set-vars.outputs.name }}
        echo "Merging the $DEVBRANCH branch into the evaluated branch "
        git fetch https://github.com/${GITHUB_REPOSITORY}.git evaluated:refs/remotes/evaluated
        git fetch https://github.com/${GITHUB_REPOSITORY}.git $DEVBRANCH:refs/remotes/$DEVBRANCH
        git checkout evaluated
        git checkout $DEVBRANCH -- doc/
        git diff
        git commit -m "Add $PROJECTS"
        git checkout main
        git checkout evaluated -- ./doc
        git diff
        git log -n 10 --oneline
        tree doc -L 2
    - name: make assets
      run: |
        doit make_assets
    - name: build website
      run: |
        doit build_website
    - name: build index redirects
      run: |
        doit index_redirects
    - uses: actions/upload-artifact@v3
      with:
        name: website
        path: builtdocs/
        retention-days: 3
    - name: Deploy dev
      # workflow_call, by pr_flow.yml
      # workflow_dispatch and dev target
      # schedule
      if: |
        (github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'dev') ||
        inputs.type == 'workflow_call' ||
        github.event_name == 'schedule'
      run: echo Deploy Dev
      # uses: peaceiris/actions-gh-pages@v3
      # with:
      #   personal_token: ${{ secrets.ACCESS_TOKEN }}
      #   external_repository: pyviz-dev/examples
      #   publish_dir: ./builtdocs
      #   force_orphan: true
    - name: Deploy main
      # merged PR
      # workflow_dispatch and main target
      # push to main (check inputs.type as workflow_call passes its context and it's push)
      if: |
        github.event.pull_request.merged == true ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'main') ||
        (github.event_name == 'push' && inputs.type != 'workflow_call')
      run: echo Deploy main
      # uses: peaceiris/actions-gh-pages@v3
      # with:
      #   github_token: ${{ secrets.GITHUB_TOKEN }}
      #   publish_dir: ./builtdocs
      #   cname: examples.pyviz.org
      #   force_orphan: true
    - name: Clean up
      run: doit clean --clean-dep website
      # TODO: remove when the last step is fixed
    - name: Check clean up
      run: git diff
    - name: Check clean up
      run: git diff --quiet --exit-code
