name: docs

on: [push]

jobs:
  build_docs:
    name: Documentation
    runs-on: 'ubuntu-latest'
    timeout-minutes: 30
    defaults:
      run:
        shell: bash -el {0}
    env:
      DESC: "Documentation build"
    if: contains(github.event.head_commit.message, 'build:')
    steps:
      - uses: hmarr/debug-action@v2
      - run: exit 1
      - uses: actions/checkout@v3
      - uses: conda-incubator/setup-miniconda@v2
        with:
          miniconda-version: "latest"
          auto-activate-base: false
          activate-environment: examples-gallery-doc
          environment-file: environment-doc.yml
      - name: Wait for build to succeed
        uses: fountainhead/action-wait-for-check@v1.1.0
        # Only when build: 
        if: contains(github.event.head_commit.message, 'build:') && !contains(github.event.head_commit.message, 'website_release')
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # name
          checkName: Build project with ...
          # TODO: what is the longest doc build?
          timeoutSeconds: 1800

      - name: conda info and list
        run: |
          conda info --all
          conda list --show-channel-urls
      - name: checkout evaluated
        run: |
          git checkout -b deploy-${GITHUB_REF#refs/*/}
          git fetch https://github.com/${GITHUB_REPOSITORY}.git evaluated:refs/remotes/evaluated
          git checkout evaluated -- ./doc
      - name: make assets
        run: |
          doit make_assets
      - name: build website
        run: |
          doit build_website
      - name: build index redirects
        run: |
          doit index_redirects
          # TODO: is this still needed?
          sudo chown -R $(id -u):$(id -g) ./builtdocs   
      - name: Deploy dev
        uses: peaceiris/actions-gh-pages@v3
        if: ${{ !contains(github.event.head_commit.message, 'website_release') }}
        with:
          personal_token: ${{ secrets.ACCESS_TOKEN }}
          external_repository: pyviz-dev/examples
          publish_dir: ./builtdocs
          force_orphan: true
      - name: Deploy main
        if: contains(github.event.head_commit.message, 'website_release')
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./builtdocs
          cname: examples.pyviz.org
          force_orphan: true
