# Called when someone is committing in a PR.

# This runs:
# - setup: to find out which projects changed compared to main
# - test: test the changed projects in a matrix
# - build: build the changed projects in a matrix, this creates a branch to save the evaluated projects
# - docs: build the dev docs, collecting the evaluated projects from `evaluated` and the new branch
name: test+build+doc

on:
  push:
    branches-ignore:
      - "main"
      - "evaluated"
      - "tmp_evaluated_**"

jobs:
  setup:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}
    timeout-minutes: 10
    outputs:
      projects: ${{ steps.set-list.outputs.projects }}
    steps:
    - uses: actions/checkout@v3
    - uses: hmarr/debug-action@v2
    - uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    - name: install deps
      # Minimal required deps to run the following script
      run: pip install doit pyyaml
    - name: infer project list
      id: set-list
      run: |
        PROJECTS=$(doit list_changed_dirs_with_main | tail -n -1)
        echo "Projects to test: $PROJECTS"
        echo "PROJECTS=$PROJECTS" >> $GITHUB_OUTPUT
  test:
    needs: setup
    uses: pyviz-topics/examples/.github/workflows/test.yml@more_workflow_fixes
    with:
      projects: ${{ needs.setup.outputs.projects }}
      type: workflow_call
  build:
    needs: [setup, test]
    uses: pyviz-topics/examples/.github/workflows/build.yml@more_workflow_fixes
    with:
      projects: ${{ needs.setup.outputs.projects }}
      type: workflow_call
  # TODO: Make sure doc runs if the PR does not update a project
  docs:
    needs: [setup, build]
    if: needs.build.result == 'success' || needs.build.result == 'skipped'
    uses: pyviz-topics/examples/.github/workflows/docs.yml@more_workflow_fixes
    with:
      target: dev
      # TODO: validate that's really the short branch name
      evaluated_branch: "tmp_evaluated_${{  github.ref_name }}"
      projects: ${{ needs.setup.outputs.projects }}
      type: workflow_call
