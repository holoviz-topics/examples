# Build a single project:
# - on push, only in evaluated mode
# - on demand, only in dryrun mode
name: build
on:
  # On push on any branch
  push:
  # Can be run from GH UI
  workflow_dispatch:
    inputs:
      project:
        # Could be a list of the available projects to make it easier to select one
        description: Project to build
        required: true
      target:
        description: Build mode
        type: choice
        options:
        - evaluated
        - dryrun
        required: true
        default: dryrun

jobs:
  build_project:
    name: Build project ${{ github.event.inputs.project }}${{ github.event.head_commit.message }}
    runs-on: 'ubuntu-latest'
    timeout-minutes: 60
    defaults:
      run:
        shell: bash -l {0} 
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    if: contains(github.event.head_commit.message, 'build:') || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - name: check project
        id: vars
        run: |
          if [[ "${{ github.event.inputs.project }}" != "" ]]
          then
            DIR="${{ github.event.inputs.project }}"
          elif [[ "${{ github.event.head_commit.message }}" != "" ]]
          then
            MSG="${{ github.event.head_commit.message }}"
            MSG="${MSG##*build:}"
            DIR="${MSG%%]*}"
          else
            echo "The workflow can only run on push or workflow_dispatch events."
            exit 1
          fi
          echo "DIR=$DIR" >> $GITHUB_OUTPUT
          if [ -e ./$DIR ]; then
            PROJECT_EXISTS=true
          else
            PROJECT_EXISTS=false
            echo "The project '$DIR' is not in the directories of the branch '$GITHUB_REF_NAME'"
            exit 1
          fi
          echo "Building the project $DIR"
          echo "PROJECT_EXISTS=$PROJECT_EXISTS" >> $GITHUB_OUTPUT
      - name: Build project ${{ matrix.project }}
        if: steps.vars.outputs.PROJECT_EXISTS == 'true'
        uses: ./.github/actions/build_one
        with:
          # inputs.target is an empty string if the event is not workflow_dispatch
          target: ${{ github.event.inputs.target }}
          project: ${{ steps.vars.outputs.DIR }}
          gh_token: ${{ secrets.GITHUB_TOKEN }}
